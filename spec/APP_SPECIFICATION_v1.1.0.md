# Vocalis Studio アプリ仕様書 v1.1.0

## 概要

Vocalis Studioは、ボイストレーニング向けのiOSアプリです。スケール（音階）再生と同時録音機能を提供し、リアルタイムのピッチ検出と録音分析により、ユーザーの歌唱練習をサポートします。

### 対応プラットフォーム
- **iOS**: 15.0以上
- **言語**: Swift 5.9+
- **UIフレームワーク**: SwiftUI

---

## 画面構成

### 1. ホーム画面 (HomeView)

アプリ起動時のメイン画面。

**主要ナビゲーション**:
| ボタン | 遷移先 | 説明 |
|--------|--------|------|
| 録音開始 | RecordingView | 録音画面へ |
| 録音一覧 | RecordingListView | 保存済み録音の管理 |
| 設定 | SettingsView | アプリ設定 |

**その他の要素**:
- **アップグレードバナー**: 無料ユーザー向けプレミアム誘導
- **デバッグメニュー**: DEBUGビルドのみ表示

---

### 2. 録音画面 (RecordingView)

スケール付き/なしの録音を行う主要画面。

#### 2.1 レイアウト
- **横向き**: 左側に設定パネル、右側にリアルタイム表示
- **縦向き**: 折りたたみ可能な設定パネル + 表示エリア
- 録音開始時に設定パネルは自動的に非表示

#### 2.2 スケール設定

**スケールパターン** (NotePattern):
| パターン | 構成音 | 説明 |
|----------|--------|------|
| 5音スケール | C, D, E, F, G | ドレミファソ |
| オクターブリピート | C, E, G, C | オクターブ循環 |
| オフ | - | スケールなし基本録音 |

**ピッチ設定**:
- **開始ピッチ**: MIDI 0-127 (デフォルト: C4 = MIDI 60)
- スケールの開始音を設定

**テンポ設定**:
- **1音あたりの秒数**: 1.0〜3.0秒 (デフォルト: 1.0秒)

**キー進行パターン** (KeyProgressionPattern):
| パターン | 説明 |
|----------|------|
| 上行のみ | 上昇のみ |
| 下行のみ | 下降のみ |
| 上行→下行 | 上昇後に下降 (デフォルト) |
| 下行→上行 | 下降後に上昇 |

**キー変更パラメータ**:
| 設定項目 | 範囲 | デフォルト |
|----------|------|-----------|
| 上行キー数 | 0〜12回 | 3 |
| 下行キー数 | 0〜12回 | 0 |
| 上行間隔 | 1〜12半音 | 1 (半音) |
| 下行間隔 | 1〜12半音 | 1 (半音) |

#### 2.3 スケール再生メカニズム

各キーの開始時に「ダンダーン」形式で告知:
- **ダン** (短音): 0.3秒、キー開始の合図
- **ダーン** (長音): 1.0秒、メジャートライアド (root + M3 + P5)

その後、設定されたスケールパターンの音が順次再生されます。

#### 2.4 録音コントロール
- **録音開始**: カウントダウン後に録音開始
- **録音停止**: 録音を停止しファイル保存
- **最後の録音再生**: 直前の録音を再生

---

### 3. リアルタイム表示エリア (RealtimeDisplayArea)

録音中・再生中のリアルタイム情報を表示。

**表示コンポーネント**:
| コンポーネント | 内容 |
|---------------|------|
| スペクトラム | 周波数スペクトルのリアルタイム可視化 |
| ピッチインジケーター | 目標ピッチ、検出ピッチ、正確度(%) |
| 音量メーター | マイク入力レベル |

---

### 4. 録音一覧画面 (RecordingListView)

保存された録音を管理する画面。

**機能**:
- 録音リスト表示 (日時順)
- 再生コントロール (前/次/再生/一時停止)
- 名前変更
- 削除 (確認ダイアログ付き)
- 分析画面への遷移

---

### 5. 分析画面 (AnalysisView)

録音の詳細分析を表示する画面。

**分析コンポーネント**:
| コンポーネント | 内容 |
|---------------|------|
| スペクトログラム | 周波数スペクトルの時系列表示 |
| ピッチグラフ | 検出ピッチの時間推移 |
| 目標スケール表示 | スケール設定時の目標音程ライン |

**機能**:
- 各グラフの拡大表示
- 再生位置との同期
- 分析結果の統計情報表示

---

### 6. ペイウォール画面 (PaywallView)

サブスクリプション購入画面。

**表示内容**:
- Free/Premiumの機能比較
- 商品名 (StoreKitから取得)
- 価格と期間 (例: ¥500/月)
- 自動更新の説明文
- 利用規約・プライバシーポリシーへのリンク

**アクション**:
- 購入ボタン
- 購入復元ボタン

---

### 7. サブスクリプション管理画面 (SubscriptionManagementView)

現在のサブスクリプション状態を確認・管理。

**表示内容**:
- 現在のティア
- 購入日・有効期限
- 利用可能な機能一覧

**アクション**:
- 購入復元
- サブスクリプション解約 (App Store設定へ)

---

### 8. 設定画面 (SettingsView)

アプリの各種設定を行う画面。

**セクション**:

| セクション | 内容 |
|-----------|------|
| サブスクリプション | 管理画面へのリンク |
| オーディオ | 入力設定、出力設定 |
| 言語 | 8言語から選択 |
| 情報 | バージョン表示 |
| 規約 | 利用規約、プライバシーポリシー |

---

## サブスクリプション

### ティア構成

| ティア | 説明 |
|--------|------|
| Free | 無料、基本機能のみ |
| Premium | 月額/年額、拡張機能 |
| Premium Plus | 月額/年額、全機能 (将来実装) |

### 録音制限

| ティア | 日次録音数 | 最大録音時間 |
|--------|-----------|-------------|
| Free | 5回 | 30秒 |
| Premium | 無制限 | 300秒 (5分) |
| Premium Plus | 無制限 | 無制限 |

### 機能制限

**Free ティア**:
- 基本録音
- リアルタイムピッチ検出
- 5音スケール再生

**Premium ティア** (追加機能):
- スペクトル可視化
- ピッチ正確度分析
- ピッチ推移グラフ
- 無制限ローカル保存

**Premium Plus ティア** (将来実装予定):
- WAVエクスポート
- 練習履歴・統計
- カスタムスケール（自由な音階設定）
- AI音程改善提案
- クラウドバックアップ

---

## ローカライゼーション

### 対応言語 (8言語)

| 言語 | コード |
|------|--------|
| 日本語 | ja |
| English | en |
| 简体中文 | zh-Hans |
| 繁體中文 | zh-Hant |
| 한국어 | ko |
| Español | es |
| Français | fr |
| Deutsch | de |

---

## オーディオ機能

### 録音
- **フォーマット**: M4A (AAC)
- **サンプルレート**: 44100 Hz
- **チャンネル**: モノラル

### スケール再生
- **音源**: MIDI音源 (選択可能)
- **対応音源**:
  - ピアノ (デフォルト)
  - エレクトリックピアノ
  - ギター
  - ビブラフォン
  - マリンバ
  - フルート
  - クラリネット
  - サイン波

### ピッチ検出
- **アルゴリズム**: AVFoundation FFT解析
- **検出範囲**: 50Hz〜2000Hz
- **更新頻度**: リアルタイム

---

## データ永続化

### ローカルストレージ
| データ | 保存先 |
|--------|--------|
| 録音ファイル | Documents/Recordings/ |
| スケール設定プリセット | UserDefaults |
| オーディオ設定 | UserDefaults |
| 分析キャッシュ | Caches/ |

### StoreKit
- サブスクリプション状態はApp Store経由で管理
- トランザクション履歴の自動更新監視

---

## 技術仕様

### アーキテクチャ
- **Clean Architecture** + **Domain-Driven Design**
- **MVVM** (Presentation層)

### レイヤー構成
```
App/              # エントリーポイント、DI
Domain/           # エンティティ、値オブジェクト、リポジトリIF
Application/      # ユースケース
Infrastructure/   # リポジトリ実装、外部サービス
Presentation/     # View、ViewModel
```

### 主要フレームワーク
| フレームワーク | 用途 |
|---------------|------|
| SwiftUI | UI |
| Combine | リアクティブプログラミング |
| AVFoundation | オーディオ録音・再生・分析 |
| StoreKit 2 | アプリ内課金 |

---

## バージョン履歴

### v1.1.0 (現行)
- StoreKitからの動的サブスクリプション情報表示
- App Store Guideline 3.1.2対応
- 8言語ローカライゼーション完備
- MIDIレンジバリデーション
- ピッチデータ永続化 (開発中)

### v1.0.0
- 初回リリース
- 基本録音機能
- スケール再生
- リアルタイムピッチ検出
- 分析機能
- サブスクリプション

---

## 関連ドキュメント

- [画面設計 v2](./SCREEN_DESIGN_V2.md)
- [分析画面仕様](./ANALYSIS_VIEW_SPECIFICATION.md)
- [ピッチ検出改善](./PITCH_DETECTION_IMPROVEMENT.md)
- [サブスクリプション設計](./SUBSCRIPTION_DESIGN.md)
